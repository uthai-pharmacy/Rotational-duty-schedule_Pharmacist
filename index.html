<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตารางเวียนหน้าที่ "เภสัชกร" รพ.อุทัย</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0077b6;
            --secondary-color: #00b4d8;
            --success-color: #198754;
            --danger-color: #dc3545;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
        }
        body { font-family: 'Kanit', sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; }
        .container { width: 100%; max-width: 1400px; margin: 0 auto; background-color: #ffffff; padding: 20px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        h1 { text-align: center; color: var(--primary-color); display: flex; align-items: center; justify-content: center; gap: 10px; margin: 0; flex-grow: 1; }
        .action-button { background-color: #6c757d; color: white; font-family: 'Kanit', sans-serif; font-size: 1em; font-weight: bold; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; }
        .action-button:hover { background-color: #5a6268; }
        #year-selector { font-family: 'Kanit', sans-serif; font-size: 1em; font-weight: bold; width: 110px; padding: 5px; border: 1px solid var(--border-color); border-radius: 5px; text-align: center; color: var(--primary-color); background-color: white; }
        .view-nav { display: flex; flex-wrap: wrap; justify-content: center; margin-bottom: 25px; border-bottom: 2px solid var(--border-color); }
        .view-nav button { padding: 12px 25px; font-family: 'Kanit', sans-serif; font-size: 1.1em; font-weight: bold; border: none; background-color: transparent; cursor: pointer; transition: color 0.3s, border-bottom 0.3s; color: #6c757d; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .view-nav button.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); }
        .controls-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; margin-bottom: 25px; padding: 15px; background-color: var(--light-bg); border-radius: 8px; gap: 20px; }
        .controls-container label { font-weight: bold; color: var(--primary-color); }
        .controls-container select { padding: 8px 12px; font-family: 'Kanit', sans-serif; font-size: 1em; border-radius: 5px; border: 1px solid #ccc; width: auto; }
        
        /* NEW: Styles for Swap Mode */
        .swap-mode-controls {
            display: flex;
            gap: 15px;
            background-color: white;
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .swap-mode-controls label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: normal;
            color: #333;
            cursor: pointer;
        }
        .swap-mode-controls input[type="radio"] {
            cursor: pointer;
        }

        .view { display: none; }
        .view.active { display: block; }
        #yearly-view .year-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .month-container { border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; }
        .month-header { text-align: center; font-weight: bold; font-size: 1.2em; margin-bottom: 10px; color: var(--primary-color); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-grid .day-header { font-weight: bold; text-align: center; font-size: 0.8em; }
        /* MODIFIED: Reverted calendar styles to original */
        .calendar-grid .day-cell { 
            height: 35px; 
            border: 1px solid #eee; 
            text-align: center; 
            font-size: 0.8em; 
            position: relative; 
        }
        .day-cell .day-number { 
            position: absolute; 
            top: 2px; 
            left: 4px; 
            font-weight: normal; 
            color: #333;
            margin-bottom: 0;
        }
        .day-cell .duty-marker { font-weight: bold; display: flex; justify-content: center; align-items: center; height: 100%; border-radius: 3px; }
        
        /* REMOVED: Styles for duty list in calendar cells */
        

        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 12px 8px; text-align: center; font-size: 14px; white-space: nowrap; }
        th { background-color: var(--primary-color); color: white; font-weight: bold; }
        .weekend-row { background-color: #fffbeb !important; }
        /* MODIFIED: Updated selectors to include new .day-cell swappables */
        #monthly-table-body td.swappable, #compare-view .day-cell.swappable { 
            cursor: pointer; 
            transition: transform 0.2s, box-shadow 0.2s; 
        }
        #monthly-table-body td.swappable:hover, #compare-view .day-cell.swappable:hover { 
            transform: scale(1.05); 
            box-shadow: 0 0 10px var(--secondary-color); 
            z-index: 10; 
            position: relative; 
        }
        /* MODIFIED: Daily swap selection */
        .swap-selected { 
            outline: 3px solid var(--secondary-color) !important; 
            outline-offset: -3px; 
            background-color: #e0f7fa !important; 
        }
        /* NEW: Weekly swap selection highlight */
        .week-selected {
            outline: 3px solid #f0ad4e; /* Warning yellow/orange */
            outline-offset: -3px;
            background-color: #fef8e7;
        }

        .swapped-animation { animation: flash-success 1s; }
        @keyframes flash-success { 0% { background-color: var(--success-color); color: white; } 100% { } }
        #summary-view th, #summary-view td { font-size: 1.1em; padding: 14px; }
        #weekly-view table { table-layout: fixed; }
        #weekly-view th, #weekly-view td { white-space: normal; padding: 10px; }
        #weekly-view .duty-label { font-weight: bold; text-align: right; background-color: var(--light-bg); }
        .legend { margin-top: 25px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        .legend-item { display: flex; align-items: center; font-size: 14px; }
        .legend-color { width: 18px; height: 18px; margin-right: 8px; border-radius: 4px; }
        .role-color-0 { background-color: #caf0f8; } .role-color-1 { background-color: #fec8a1; }
        .role-color-2 { background-color: #ffb3c1; } .role-color-3 { background-color: #d9f99d; }
        .role-color-4 { background-color: #e5e7eb; } .role-color-5 { background-color: #cce5ff; }
        .role-color-6 { background-color: #d4edda; } .role-color-7 { background-color: #f8d7da; }
        .role-color-8 { background-color: #fff3cd; } .role-color-9 { background-color: #d1ecf1; }
        #reset-swaps-button { background-color: var(--danger-color); }
        #reset-swaps-button:hover { background-color: #b02a37; }

        /* MODIFIED: Added style for highlighting repeat duties */
        .duty-repeat-warning {
            outline: 3px solid var(--danger-color) !important;
            outline-offset: -2px;
            box-shadow: 0 0 10px var(--danger-color);
            animation: pulse-danger 1.5s infinite;
        }
        @keyframes pulse-danger {
            0% { box-shadow: 0 0 5px rgba(220, 53, 69, 0.4); }
            50% { box-shadow: 0 0 15px rgba(220, 53, 69, 1); }
            100% { box-shadow: 0 0 5px rgba(220, 53, 69, 0.4); }
        }


        /* Modal Styles */
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fff; margin: 5% auto; padding: 30px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.2); width: 90%; max-width: 800px; position: relative; }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-close:hover, .modal-close:focus { color: black; text-decoration: none; }
        .modal-content h2 { margin: 0 0 15px 0; font-size: 1.5em; color: var(--primary-color); }
        .management-section { margin-bottom: 25px; padding: 20px; border: 1px solid #bde0fe; background-color: #f7fcff; border-radius: 8px; }
        .personnel-controls { display: flex; justify-content: center; align-items: center; gap: 15px; }
        .personnel-controls label { font-weight: bold; }
        .personnel-controls input[type="number"] { width: 70px; padding: 8px; font-family: 'Kanit', sans-serif; font-size: 1em; border-radius: 5px; border: 1px solid #ccc; }
        .duty-management-note { text-align: center; color: #555; font-size: 0.9em; margin-top: 10px; }
        #duty-inputs-grid, #name-inputs-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 15px; }
        .input-group label { font-weight: bold; margin-bottom: 5px; color: var(--primary-color); font-size: 0.9em; }
        .input-group input { padding: 10px; border: 1px solid #bde0fe; border-radius: 5px; font-family: 'Kanit', sans-serif; font-size: 16px; width: 100%; box-sizing: border-box; }
        .action-button-modal { background-color: var(--secondary-color); color: white; font-family: 'Kanit', sans-serif; font-size: 1em; font-weight: bold; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; }
        .action-button-modal:hover { background-color: #0096c7; }
        .generate-link-container { text-align: center; margin-top: 30px; }
        #generate-link-button { background-color: var(--success-color); font-size: 1.2em; padding: 15px 30px; }
        #generate-link-button:hover { background-color: #157347; }
        
        /* NEW: Styles to reduce calendar size specifically in compare-view AND monthly-view */
        #compare-view .month-container, #monthly-view .month-container {
            padding: 8px; /* Reduced from 10px */
        }
        #compare-view .calendar-grid, #monthly-view .calendar-grid {
            gap: 2px; /* Reduced from 4px */
        }
        #compare-view .calendar-grid .day-header, #monthly-view .calendar-grid .day-header {
            font-size: 0.7em; /* Reduced from 0.8em */
            padding-bottom: 2px;
        }
        /* MODIFIED: Adjusted height for monthly-view to fit all duties */
        #compare-view .calendar-grid .day-cell {
             height: 30px; /* Keep compare view small */
             font-size: 0.7em; 
        }
        #monthly-view .calendar-grid .day-cell {
            /* MODIFIED: Set fixed height for uniform cells */
            /* height: 160px; */ /* REMOVED: Fixed height caused overflow */
            height: auto; /* NEW: Allow height to grow with content */
            min-height: 160px; /* NEW: Keep cells looking uniform */
            font-size: 0.7em; 
            vertical-align: top;
            padding: 4px;
            /* NEW: Ensure content starts top-left */
            display: flex; 
            flex-direction: column;
            align-items: flex-start;
        }
        /* MODIFIED: Split the selector. Compare view uses absolute positioning. */
        #compare-view .day-cell .day-number {
            position: absolute; /* Reverted */
            top: 2px;
            left: 2px;
            font-weight: normal; /* Reverted */
            margin-bottom: 0;
        }
         /* Monthly view uses relative positioning */
        #monthly-view .day-cell .day-number {
            position: relative; 
            font-weight: bold; 
            margin-bottom: 4px;
            /* Removed top/left */
        }

        /* MODIFIED: Restored the duty-marker style for compare-view */
        #compare-view .day-cell .duty-marker {
            font-size: 0.9em; /* Make marker text slightly smaller */
            font-weight: bold; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100%; 
            border-radius: 3px;
        }
        

        /* NEW: Styles for duty list in monthly view calendar cells (Re-added) */
        #monthly-view .duty-list {
            display: flex;
            flex-direction: column;
            gap: 3px;
            width: 100%; /* Ensure list takes full width */
        }
        #monthly-view .duty-item {
            /* MODIFIED: Increased font size for readability */
            font-size: 0.9em; /* MODIFIED: Reduced from 1em to help fit */
            padding: 3px 5px;
            border-radius: 4px;
            /* white-space: nowrap; */ /* REMOVED: Allow wrapping for long duty names */
            overflow: hidden;
            text-overflow: ellipsis;
            border: 1px solid transparent; /* Placeholder for alignment */
        }
        /* No hover/swap styles needed for monthly view items */
        #monthly-view .duty-item.duty-repeat-warning {
             box-shadow: 0 0 8px var(--danger-color);
            border: 1px solid var(--danger-color);
            animation: pulse-danger-subtle 1.5s infinite;
        }
         @keyframes pulse-danger-subtle {
            0% { box-shadow: 0 0 3px rgba(220, 53, 69, 0.3); }
            50% { box-shadow: 0 0 10px rgba(220, 53, 69, 0.7); }
            100% { box-shadow: 0 0 3px rgba(220, 53, 69, 0.3); }
        }


        /* NEW: Center the single calendar in monthly view */
        #monthly-calendar-container .month-container {
            /* MODIFIED: Increased max-width */
            max-width: 800px; 
            width: 100%;
        }


        /* NEW: Styles for Swap View */
        #compare-view .controls-container { justify-content: space-around; }
        #compare-view h2 { text-align: center; color: var(--primary-color); margin-top: 0px; margin-bottom: 10px; font-size: 1.3em; }
        
        /* MODIFIED: Changed layout for Compare View (Desktop-First 2x3) */
        /* MODIFIED: Increased selector specificity to override cache */
        div#compare-view.view div.year-grid#compare-grid {
            /* --- FIX: Added display: grid; and gap: --- */
            display: grid;
            gap: 20px; 
            /* MODIFIED: Default: 2 columns (2x3 layout) as requested */
            grid-template-columns: 1fr 1fr;
        }
        
        /* On tablets (screens <= 1024px), drop to 2 columns */
        /* @media (max-width: 1024px) { ... } // This breakpoint is no longer needed */
         
        /* On phones (screens <= 640px), drop to 1 column */
        @media (max-width: 640px) {
            /* MODIFIED: Increased selector specificity to override cache */
            div#compare-view.view div.year-grid#compare-grid {
                display: grid; /* Ensure display: grid is set here too */
                gap: 20px;
                grid-template-columns: 1fr;
            }
        }


        /* MODIFIED: Removed Grid layout. Tables will now stack vertically by default. */
        /*
        #swap-view .swap-table-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }
        */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span>🗓️ ตารางเวียนหน้าที่ "เภสัชกร" รพ.อุทัย ปี พ.ศ.</span>
                <select id="year-selector"></select>
            </h1>
            <button id="settings-button" class="action-button">⚙️ ตั้งค่า</button>
        </div>
        
        <div id="main-content">
            <div class="view-nav">
                <button id="nav-yearly" class="active">ภาพรวมรายปี</button>
                <button id="nav-monthly">ภาพรวมรายเดือน</button>
                <!-- MODIFIED: Fixed the button ID to match the view ID -->
                <button id="nav-compare">เทียบเวร (รายเดือน)</button> 
                <button id="nav-weekly">ภาพรวมรายสัปดาห์</button>
                <button id="nav-summary">สรุปภาพรวม</button>
            </div>
            
            <div id="yearly-view" class="view active">
                 <div class="controls-container"><label for="yearly-pharmacist-selector">แสดงหน้าที่ของ:</label><select id="yearly-pharmacist-selector"></select></div>
                 <div class="year-grid" id="yearly-grid"></div>
            </div>
            <div id="monthly-view" class="view">
                 <div class="controls-container">
                     <label for="monthly-selector">เลือกเดือน:</label>
                     <select id="monthly-selector"></select>
                     
                     <!-- REMOVED: Pharmacist Selector -->
                     
                     <!-- REMOVED: Reset Swaps Button (Moved to compare-view) -->
                 </div>
                 <!-- MODIFIED: Changed from table to calendar view -->
                 <div id="monthly-calendar-container" style="display: flex; justify-content: center; padding: 0 20px;">
                    <!-- Single calendar showing ALL duties will be generated here -->
                 </div>
            </div>

            <!-- MODIFIED: Renamed view to compare-view -->
            <div id="compare-view" class="view">
                <div class="controls-container">
                    <!-- MODIFIED: Only one month selector needed -->
                    <div>
                        <label for="compare-month-selector">เลือกเดือนเพื่อเทียบเวร:</label>
                        <select id="compare-month-selector"></select>
                    </div>

                    <!-- NEW: Swap Mode Selector (Moved from monthly-view) -->
                    <div class="swap-mode-controls">
                       <label>
                           <input type="radio" name="swap-mode" value="week" checked>
                           สลับรายสัปดาห์
                       </label>
                       <label>
                           <input type="radio" name="swap-mode" value="day">
                           สลับรายวัน
                       </label>
                    </div>

                    <!-- NEW: Moved Reset Swaps Button here -->
                    <button id="reset-swaps-button" class="action-button">ล้างการสลับเวร (เดือนนี้)</button>
                </div>
                
                <!-- MODIFIED: Changed to a year-grid layout -->
                <div class="year-grid" id="compare-grid">
                    <!-- Calendars will be generated here by JS -->
                </div>

            </div>
            <!-- END: Compare View -->

            <div id="weekly-view" class="view">
                 <div class="controls-container"><label for="weekly-selector">เลือกสัปดาห์:</label><select id="weekly-selector"></select></div>
                 <div class="table-responsive"><table id="weekly-table"></table></div>
            </div>
            <div id="summary-view" class="view"><div class="table-responsive"><table id="summary-table"></table></div></div>
            <div class="legend"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>⚙️ ตั้งค่าตารางเวร</h2>
            <div class="management-section">
                <h2>1. กำหนดจำนวนและหน้าที่</h2>
                <div class="personnel-controls">
                    <label for="pharmacist-count">จำนวนเภสัชกร:</label>
                    <input type="number" id="pharmacist-count" min="1" value="6">
                    <button id="update-personnel-button" class="action-button-modal">อัปเดต</button>
                </div>
                <div class="duty-management-note">หมายเหตุ: จำนวนหน้าที่ต้องเท่ากับจำนวนเภสัชกรเสมอ</div>
                <div id="duty-inputs-grid"></div>
            </div>
            <div class="management-section">
                <h2>2. กรอกชื่อเภสัชกร</h2>
                <div id="name-inputs-grid"></div>
            </div>
            <div class="generate-link-container">
                <button id="generate-link-button" class="action-button-modal">💾 บันทึกและสร้างลิงก์ใหม่</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert/Confirm Modal -->
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <h2 id="custom-modal-title" style="margin-bottom: 20px;"></h2>
            <p id="custom-modal-message" style="font-size: 1.1em; margin-bottom: 25px;"></p>
            <div id="custom-modal-buttons" style="display: flex; justify-content: center; gap: 15px;">
                <button id="custom-modal-confirm" class="action-button-modal" style="background-color: var(--success-color);"></button>
                <button id="custom-modal-cancel" class="action-button" style="background-color: var(--danger-color);"></button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        const THAI_MONTHS = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
        const THAI_DAYS_SHORT = ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'];
        const THAI_DAYS_FULL = ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'];
        const COLOR_PALETTE = ['role-color-0', 'role-color-1', 'role-color-2', 'role-color-3', 'role-color-4', 'role-color-5', 'role-color-6', 'role-color-7', 'role-color-8', 'role-color-9'];
        let pharmacistCount = 0;
        let duties = [];
        let pharmacistNames = [];
        let manualOverrides = {};
        let firstSwapSelection = null;
        let fullYearSchedule = {};
        let customModalConfirmCallback = null;

        // --- DOM ELEMENTS ---
        const yearSelector = document.getElementById('year-selector');
        const views = document.querySelectorAll('.view');
        const navButtons = document.querySelectorAll('.view-nav button');
        const settingsModal = document.getElementById('settings-modal');
        const settingsButton = document.getElementById('settings-button');
        const closeModalButton = document.querySelector('.modal-close');
        const personnelCountInput = document.getElementById('pharmacist-count');
        const personnelUpdateButton = document.getElementById('update-personnel-button');
        const dutyInputsGrid = document.getElementById('duty-inputs-grid');
        const nameInputsGrid = document.getElementById('name-inputs-grid');
        const generateLinkButton = document.getElementById('generate-link-button');
        const resetSwapsButton = document.getElementById('reset-swaps-button');

        // --- CORE LOGIC ---

        // --- FIX: Moved isSameDutyCategory to global scope ---
        const isSameDutyCategory = (d1, d2) => {
            if (!d1 || !d2) return false;
            const category1 = d1.includes('Dispense') ? 'Dispense' : d1;
            const category2 = d2.includes('Dispense') ? 'Dispense' : d2;
            return category1 === category2;
        };

        /**
         * NEW: Pre-calculates screener assignments to ensure Rule #1 (2 duties per person) is met.
         * This runs *before* the main schedule generation.
         */
        // --- FIX: Restored the full, correct function definition ---
        function preCalculateScreenerAssignments(year, screenerWeeksMap, pharmacistNames, screenerDuty) {
            const screenerAssignments = new Map(); // mondayString -> pharmacistName
            const screenerCounts = {};
            pharmacistNames.forEach(name => screenerCounts[name] = 0);
            
            // Sort screener weeks chronologically
            const screenerWeeks = Array.from(screenerWeeksMap.keys()).sort();

            let lastScreenerAssigned = null; // To avoid back-to-back months if possible

            screenerWeeks.forEach(mondayString => {
                let bestPerson = null;
                let minCount = Infinity;

                // Find all people with the minimum screener count
                pharmacistNames.forEach(name => {
                    const count = screenerCounts[name];
                    if (count < minCount) {
                        minCount = count;
                    }
                });
                
                // Get all candidates who have this minimum count
                const candidates = pharmacistNames.filter(name => screenerCounts[name] === minCount);

                if (candidates.length === 1) {
                    // Only one person has the minimum count, must assign to them
                    bestPerson = candidates[0];
                } else {
                    // Multiple candidates, try to avoid assigning the same person as last month
                    const nonRepeatingCandidates = candidates.filter(name => name !== lastScreenerAssigned);
                    if (nonRepeatingCandidates.length > 0) {
                        bestPerson = nonRepeatingCandidates[0]; // Pick the first available non-repeating
                    } else {
                        bestPerson = candidates[0]; // All candidates would repeat, just pick the first
                    }
                }

                // Assign the duty
                screenerAssignments.set(mondayString, bestPerson);
                screenerCounts[bestPerson]++;
                lastScreenerAssigned = bestPerson;
            });
            
            // console.log("Final Screener Counts:", screenerCounts); // Debug
            return screenerAssignments;
        }

        function generateFullYearSchedule(year) {
            fullYearSchedule = {};
            if (duties.length === 0 || pharmacistNames.length === 0) return;

            const getPermutations = (arr) => {
                // ... (This function relies on the closing brace of preCalculateScreenerAssignments,
                // but since that function was broken, the error occurred before this point.
                // Now that the function above is fixed, we need to add the *rest* of the JS code.)
                // --- START: Restoring missing JS code ---
                if (arr.length === 0) return [[]];
                const firstElement = arr[0];
                const rest = arr.slice(1);
                const permsWithoutFirst = getPermutations(rest);
                const allPermutations = [];
                permsWithoutFirst.forEach(perm => {
                    for (let i = 0; i <= perm.length; i++) {
                        const permWithFirst = [...perm.slice(0, i), firstElement, ...perm.slice(i)];
                        allPermutations.push(permWithFirst);
                    }
                });
                // Simple factorial check to prevent crash on large N (e.g., N > 7)
                if (allPermutations.length > 5040) { // 7! = 5040
                     // console.warn(`Permutation count too high (${arr.length}!). Using sliced array.`);
                     return allPermutations.slice(0, 5040); // Return a subset
                }
                return allPermutations;
            };

            let allMondays = [];
            let date = new Date(year, 0, 1);
            if (date.getDay() !== 1) { date.setDate(date.getDate() + (8 - date.getDay()) % 7); }
             if (date.getFullYear() < year) { date.setDate(date.getDate() + 7); } 
            while (date.getFullYear() === year) {
                allMondays.push(new Date(date));
                date.setDate(date.getDate() + 7);
            }

            const firstWeekMondays = new Map();
            const screenerDuty = duties.find(d => d.toLowerCase().includes('screen')) || duties[0];
            
            // Find screener weeks
            for (let month = 0; month < 12; month++) {
                let firstThursday = new Date(year, month, 1);
                while (firstThursday.getDay() !== 4) { firstThursday.setDate(firstThursday.getDate() + 1); }
                let mondayOfFirstWeek = new Date(firstThursday);
                mondayOfFirstWeek.setDate(mondayOfFirstWeek.getDate() - 3);
                firstWeekMondays.set(mondayOfFirstWeek.toISOString().split('T')[0], month);
            }

            // --- NEW: Run Rule #1 (Screener) First ---
            const screenerAssignments = preCalculateScreenerAssignments(year, firstWeekMondays, pharmacistNames, screenerDuty);
            
            let lastWeekAssignments = null; // Map { pharmacistName: duty }
            let workload = {}; // Map { pharmacistName: { duty: count } }
            pharmacistNames.forEach(name => {
                workload[name] = {};
                duties.forEach(duty => workload[name][duty] = 0);
            });
            // REMOVED: screenerCounts - no longer needed here, handled in preCalculateScreenerAssignments

            const assignWeek = (monday, dutyMap) => {
                for (let i = 0; i < 5; i++) {
                    const d = new Date(monday);
                    d.setDate(d.getDate() + i);
                    if (d.getFullYear() === year) {
                        const dateString = `${year}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                        fullYearSchedule[dateString] = {};
                        for (const phName in dutyMap) {
                            fullYearSchedule[dateString][dutyMap[phName]] = phName;
                        }
                    }
                }
            };
            
            // REMOVED: isSameDutyCategory definition moved to global scope

            // Calculate cost (Rules #2 and #3 ONLY)
             const calculateCost = (permutationMap, people, lastAssignments, currentWorkload) => {
                // Rule #2: Repetition cost
                let repetitionCost = 0;
                if (lastAssignments) {
                    people.forEach(p => {
                        // FIX: Ensure permutationMap[p] exists before calling isSameDutyCategory
                        if (permutationMap[p] && isSameDutyCategory(lastAssignments[p], permutationMap[p])) {
                            // MODIFIED: Rule #2 has a high, but not infinite, cost.
                            repetitionCost += 100000; 
                        }
                    });
                }
                
                // Rule #3: Imbalance cost
                // This score is now the *only* thing that matters if Rule #2 is passed.
                const tempWorkload = JSON.parse(JSON.stringify(currentWorkload));
                people.forEach(p => {
                    if (permutationMap[p]) { // Ensure the person has a duty in this map
                         tempWorkload[p][permutationMap[p]]++;
                    }
                });
                
                let imbalanceScore = 0; 
                const dutyArrays = {};
                duties.forEach(d => dutyArrays[d] = []);
                Object.keys(tempWorkload).forEach(p => {
                    for (const d in tempWorkload[p]) {
                        dutyArrays[d].push(tempWorkload[p][d]);
                    }
                });
                for (const duty in dutyArrays) {
                    const counts = dutyArrays[duty];
                    if (counts.length > 1) {
                        const max = Math.max(...counts);
                        const min = Math.min(...counts);
                        imbalanceScore += (max - min); 
                    }
                }
                
                // REMOVED: All screenerCost logic. Rule #1 is already handled.
                
                // MODIFIED: The only cost is imbalance, as repetition is now a filter (Infinity).
                return repetitionCost + imbalanceScore;
            };
            
            allMondays.forEach(monday => {
                const mondayString = monday.toISOString().split('T')[0];
                const isScreenerWeek = screenerAssignments.has(mondayString); // MODIFIED
                
                let fixedAssignments = {};
                let peopleForPermutation = pharmacistNames;
                let tasksForPermutation = duties;

                if (isScreenerWeek) {
                    // --- This is a Screener Week ---
                    // Rule #1: Get the pre-calculated assignment
                    const designatedScreener = screenerAssignments.get(mondayString);
                    fixedAssignments[designatedScreener] = screenerDuty;

                    // Filter people and tasks for Rule #2 and #3
                    peopleForPermutation = pharmacistNames.filter(p => p !== designatedScreener);
                    tasksForPermutation = duties.filter(d => d !== screenerDuty);
                }
                // --- End Screener Week Logic ---

                const taskPerms = getPermutations(tasksForPermutation); 
                let bestPermutation = null;
                let bestCost = Infinity;

                // Try all permutations for the *remaining* people/tasks
                taskPerms.forEach(perm => {
                    const permutationMap = {};
                    peopleForPermutation.forEach((p, i) => permutationMap[p] = perm[i]); // Map remaining people
                    
                    // Create a *full* map (including fixed screener) to check for repetitions
                    const fullPermutationMap = { ...fixedAssignments, ...permutationMap };

                    // Pass all info to the cost function
                    // We check cost against *all* people, but only permute the *remaining* people
                    const cost = calculateCost(fullPermutationMap, pharmacistNames, lastWeekAssignments, workload);

                    if (cost < bestCost) { // Will only select schedules where cost is NOT Infinity
                        bestCost = cost;
                        bestPermutation = perm;
                    }
                });
                
                // Failsafe: if bestPermutation is STILL null (e.g., all returned Infinity)
                if (bestPermutation === null) {
                    // This happens if *every* possible permutation resulted in a repetition (cost=Infinity)
                    // We must re-run but ignore the repetition cost (Pass 2: Relaxed Mode)
                    // console.error(`Could not find a valid schedule for week ${mondayString}. Relaxing repetition rule...`);
                    bestCost = Infinity;
                     taskPerms.forEach(perm => {
                        const permutationMap = {};
                        peopleForPermutation.forEach((p, i) => permutationMap[p] = perm[i]);
                        const fullPermutationMap = { ...fixedAssignments, ...permutationMap };
                        
                        // Recalculate, but ignore repetition cost (pass null for lastAssignments)
                        // This time, we only care about imbalance (Rule #3)
                        const cost = calculateCost(fullPermutationMap, pharmacistNames, null, workload); 
                        if (cost < bestCost) {
                            bestCost = cost;
                            bestPermutation = perm;
                        }
                    });
                     if (bestPermutation === null && taskPerms.length > 0) {
                        bestPermutation = taskPerms[0] || []; // Absolute failsafe
                     }
                }

                // Construct the final assignment map for the week
                const currentWeekAssignments = { ...fixedAssignments }; // Start with screener
                if(bestPermutation){
                     peopleForPermutation.forEach((p, i) => currentWeekAssignments[p] = bestPermutation[i]); // Add the rest
                }

                assignWeek(monday, currentWeekAssignments);
                lastWeekAssignments = currentWeekAssignments;
                
                // Update workload (screener is now included here)
                for (const phName in currentWeekAssignments) {
                    const assignedDuty = currentWeekAssignments[phName];
                    if (workload[phName] && assignedDuty) {
                         workload[phName][assignedDuty]++;
                    }
                }
                // REMOVED: screenerCounts update, no longer needed.
            });
        }


        function getDutiesForDate(date) {
            if (duties.length === 0 || pharmacistNames.length === 0) return null;
            const dayOfWeek = date.getDay();
            if (dayOfWeek === 0 || dayOfWeek === 6) return null;

            const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const baseDutyMap = fullYearSchedule[dateString] || {};
            
            const override = manualOverrides[dateString];
            if (override) {
                return { ...baseDutyMap, ...override };
            }
            return baseDutyMap;
        }

        // --- VIEW & UI LOGIC ---
        function switchView(viewId) { 
            views.forEach(view => view.classList.remove('active'));
            navButtons.forEach(btn => btn.classList.remove('active'));
            
            const viewToShow = document.getElementById(viewId);
            const buttonToActivate = document.getElementById(`nav-${viewId.split('-')[0]}`);

            // MODIFIED: Added checks to prevent TypeError if element is not found
            if (viewToShow) {
                viewToShow.classList.add('active');
            }
            if (buttonToActivate) {
                buttonToActivate.classList.add('active');
            } else if (viewId === 'compare-view') { 
                // Fallback check specifically for the renamed 'compare' tab
                document.getElementById('nav-compare')?.classList.add('active');
            }
        }
        function getRoleClass(dutyKey) {
            const dutyIndex = duties.indexOf(dutyKey);
            return COLOR_PALETTE[dutyIndex % COLOR_PALETTE.length] || '';
        }

        // --- RENDER VIEWS ---
        function renderYearlyView() { 
            const year = parseInt(yearSelector.value) - 543;
            const grid = document.getElementById('yearly-grid');
            const selector = document.getElementById('yearly-pharmacist-selector');
            if (pharmacistNames.length === 0) return;
            const selectedPharmacistIndex = selector.value ? parseInt(selector.value) : 0;
            grid.innerHTML = '';
            THAI_MONTHS.forEach((monthName, monthIndex) => {
                const monthContainer = document.createElement('div');
                monthContainer.className = 'month-container';
                monthContainer.innerHTML = `<div class="month-header">${monthName}</div>`;
                const calendarGrid = document.createElement('div');
                calendarGrid.className = 'calendar-grid';
                THAI_DAYS_SHORT.forEach(day => calendarGrid.innerHTML += `<div class="day-header">${day}</div>`);
                const firstDay = new Date(year, monthIndex, 1);
                for (let i = 0; i < firstDay.getDay(); i++) { calendarGrid.innerHTML += `<div class="day-cell empty"></div>`; }
                const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, monthIndex, day);
                    const dutiesMap = getDutiesForDate(date);
                    let cellContent = `<div class="day-number">${day}</div>`;
                    if (dutiesMap) {
                        for (const duty in dutiesMap) {
                            if (dutiesMap[duty] === pharmacistNames[selectedPharmacistIndex]) {
                                cellContent += `<div class="duty-marker ${getRoleClass(duty)}">${duty.substring(0,3)}</div>`;
                                break;
                            }
                        }
                    }
                    calendarGrid.innerHTML += `<div class="day-cell">${cellContent}</div>`;
                }
                monthContainer.appendChild(calendarGrid);
                grid.appendChild(monthContainer);
            });
        }
        
        // --- NEW: Refactored monthly view logic ---
        // REMOVED: generateMonthlyTable is no longer needed
        
            
        // MODIFIED: renderMonthlyView now generates a calendar showing all duties
        function renderMonthlyView() { 
            const year = parseInt(yearSelector.value) - 543;
            const selectedMonth = parseInt(document.getElementById('monthly-selector').value);
            const container = document.getElementById('monthly-calendar-container');
            container.innerHTML = ''; // Clear old grid

            if (pharmacistNames.length === 0) return;

            // --- Start: Calendar generation logic (similar to old compare view) ---
            const monthContainer = document.createElement('div');
            monthContainer.className = 'month-container';
            // Use Month name as title
            monthContainer.innerHTML = `<div class="month-header">${THAI_MONTHS[selectedMonth]}</div>`;
            
            const calendarGrid = document.createElement('div');
            calendarGrid.className = 'calendar-grid';
            
            THAI_DAYS_SHORT.forEach(day => calendarGrid.innerHTML += `<div class="day-header">${day}</div>`);
            
            const firstDay = new Date(year, selectedMonth, 1);
            for (let i = 0; i < firstDay.getDay(); i++) { 
                calendarGrid.innerHTML += `<div class="day-cell empty"></div>`; 
            }
            
            const daysInMonth = new Date(year, selectedMonth + 1, 0).getDate();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, selectedMonth, day);
                const dateString = `${year}-${String(selectedMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayOfWeek = date.getDay();
                const dutiesMap = getDutiesForDate(date);
                
                // Get duties from 7 days ago to check for repeats
                const prevWeekDate = new Date(date);
                prevWeekDate.setDate(date.getDate() - 7);
                const prevDutiesMap = getDutiesForDate(prevWeekDate);

                let cellContent = `<div class="day-number">${day}</div>`;
                
                if (dutiesMap && dayOfWeek !== 0 && dayOfWeek !== 6) {
                    cellContent += `<div class="duty-list">`;
                    // Loop through ALL duties defined in settings
                    duties.forEach(duty => { 
                        const currentPharmacist = dutiesMap[duty];
                        if (currentPharmacist) {
                            let isRepeat = false;
                            // Check for repeats from last week
                            if (prevDutiesMap) {
                                for (const prevDuty in prevDutiesMap) {
                                    if (prevDutiesMap[prevDuty] === currentPharmacist && isSameDutyCategory(duty, prevDuty)) {
                                        isRepeat = true;
                                        break;
                                    }
                                }
                            }
                            
                            const repeatClass = isRepeat ? 'duty-repeat-warning' : '';
                            const roleClass = getRoleClass(duty);
                            
                            // Create duty item (NOT swappable in this view)
                            cellContent += `<div class="duty-item ${roleClass} ${repeatClass}">`; 
                            cellContent += `${duty}: ${currentPharmacist}`;
                            cellContent += `</div>`;
                        }
                    });
                    cellContent += `</div>`;
                }

                const cell = document.createElement('div');
                cell.className = 'day-cell';
                 if (dayOfWeek === 0 || dayOfWeek === 6) {
                    cell.classList.add('weekend-row'); 
                }
                cell.innerHTML = cellContent;
                calendarGrid.appendChild(cell);
            }
            
            monthContainer.appendChild(calendarGrid);
            container.appendChild(monthContainer);
            // --- End: Calendar generation logic ---
        }
        
        // REMOVED: The generateMonthlyCalendar function is no longer needed.
        

        // MODIFIED: Function to render the new Compare View
        function renderCompareView() {
            const year = parseInt(yearSelector.value) - 543;
            const selectedMonth = parseInt(document.getElementById('compare-month-selector').value);
            const grid = document.getElementById('compare-grid');
            grid.innerHTML = ''; // Clear old grid

            if (pharmacistNames.length === 0) return;

            // Loop for each pharmacist
            pharmacistNames.forEach((phName, phIndex) => {
                const monthContainer = document.createElement('div');
                monthContainer.className = 'month-container';
                // Add Pharmacist name as title
                monthContainer.innerHTML = `<h2>${phName}</h2><div class="month-header">${THAI_MONTHS[selectedMonth]}</div>`;
                
                const calendarGrid = document.createElement('div');
                calendarGrid.className = 'calendar-grid';
                
                THAI_DAYS_SHORT.forEach(day => calendarGrid.innerHTML += `<div class="day-header">${day}</div>`);
                
                const firstDay = new Date(year, selectedMonth, 1);
                for (let i = 0; i < firstDay.getDay(); i++) { 
                    calendarGrid.innerHTML += `<div class="day-cell empty"></div>`; 
                }
                
                const daysInMonth = new Date(year, selectedMonth + 1, 0).getDate();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, selectedMonth, day);
                    const dateString = `${year}-${String(selectedMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dutiesMap = getDutiesForDate(date);
                    
                    let phDuty = null;
                    if (dutiesMap) {
                        for (const duty in dutiesMap) {
                            if (dutiesMap[duty] === phName) {
                                phDuty = duty;
                                break;
                            }
                        }
                    }

                    const cell = document.createElement('div');
                    cell.className = 'day-cell';
                    let cellContent = `<div class="day-number">${day}</div>`;

                    if (phDuty) {
                        cell.classList.add('swappable');
                        cell.dataset.date = dateString;
                        cell.dataset.duty = phDuty;
                        cell.dataset.pharmacist = phName; // Store pharmacist name in dataset
                        cellContent += `<div class="duty-marker ${getRoleClass(phDuty)}">${phDuty.substring(0,3)}</div>`;
                        
                        // Check for repeats (from monthly view logic)
                        const prevWeekDate = new Date(date);
                        prevWeekDate.setDate(date.getDate() - 7);
                        const prevDutiesMap = getDutiesForDate(prevWeekDate);
                        if (prevDutiesMap) {
                            for (const prevDuty in prevDutiesMap) {
                                // --- FIX: Call isSameDutyCategory correctly ---
                                if (prevDutiesMap[prevDuty] === phName && isSameDutyCategory(phDuty, prevDuty)) {
                                    cell.classList.add('duty-repeat-warning');
                                    break;
                                }
                            }
                        }
                    }
                    
                    cell.innerHTML = cellContent;
                    
                    // Add listener only if it's a valid duty cell
                    if (phDuty) {
                        cell.addEventListener('click', handleSwapClick);
                    }
                    calendarGrid.appendChild(cell);
                }
                
                monthContainer.appendChild(calendarGrid);
                grid.appendChild(monthContainer);
            });
        }


        function renderWeeklyView() {
            const year = parseInt(yearSelector.value) - 543;
            const selectedWeekIndex = parseInt(document.getElementById('weekly-selector').value);
            const table = document.getElementById('weekly-table');
            table.innerHTML = '';
            
            let headerHtml = '<thead><tr><th>หน้าที่</th>';
             // Correctly calculate the start date of the selected week's Monday
            let mondaysInYear = [];
            let d = new Date(year, 0, 1);
            if (d.getDay() !== 1) { d.setDate(d.getDate() + (8 - d.getDay()) % 7); }
             if (d.getFullYear() < year) { d.setDate(d.getDate() + 7); } // Ensure we start within the correct year
            while(d.getFullYear() === year) {
                mondaysInYear.push(new Date(d));
                d.setDate(d.getDate() + 7);
            }
            const mondayOfSelectedWeek = mondaysInYear[selectedWeekIndex];

            if(mondayOfSelectedWeek){
                for (let i = 0; i < 7; i++) {
                    const date = new Date(mondayOfSelectedWeek);
                    date.setDate(date.getDate() + i);
                    headerHtml += `<th>${THAI_DAYS_FULL[date.getDay()]}<br><small>${date.getDate()}/${date.getMonth()+1}</small></th>`;
                }
            }
            headerHtml += '</tr></thead>';
            table.innerHTML = headerHtml;

            let bodyHtml = '<tbody>';
            duties.forEach(duty => {
                bodyHtml += `<tr><td class="duty-label ${getRoleClass(duty)}">${duty}</td>`;
                for (let i = 0; i < 7; i++) {
                     let phName = '-';
                     let cellClass = '';
                     if(mondayOfSelectedWeek){
                         const date = new Date(mondayOfSelectedWeek);
                         date.setDate(date.getDate() + i);
                         const dutiesForDay = getDutiesForDate(date);
                         if (dutiesForDay && dutiesForDay[duty]) {
                             phName = dutiesForDay[duty];
                             cellClass = getRoleClass(duty);
                         }
                     }
                    bodyHtml += `<td class="${cellClass}">${phName}</td>`;
                }
                bodyHtml += '</tr>';
            });
            bodyHtml += '</tbody>';
            table.innerHTML += bodyHtml;
        }
        function renderSummaryView() { 
            const year = parseInt(yearSelector.value) - 543;
            const summaryTable = document.getElementById('summary-table');
            const summaryData = {};
            pharmacistNames.forEach(name => {
                summaryData[name] = {};
                duties.forEach(key => summaryData[name][key] = 0);
            });

            const date = new Date(year, 0, 1);
            while (date.getFullYear() === year) {
                const dutiesMap = getDutiesForDate(date);
                if (dutiesMap) {
                    for (const dutyKey in dutiesMap) {
                        const pharmacistName = dutiesMap[dutyKey];
                        if (summaryData[pharmacistName]) {
                            summaryData[pharmacistName][dutyKey]++;
                        }
                    }
                }
                date.setDate(date.getDate() + 1);
            }
            
            summaryTable.innerHTML = '';
            let headerHtml = '<thead><tr><th>เภสัชกร</th>';
            duties.forEach(key => headerHtml += `<th>${key}</th>`);
            headerHtml += '</tr></thead>';
            summaryTable.innerHTML = headerHtml;

            let bodyHtml = '<tbody>';
            pharmacistNames.forEach(name => {
                bodyHtml += `<tr><td>${name}</td>`;
                duties.forEach(duty => {
                    const dayCount = summaryData[name][duty] || 0;
                    let displayStr = '0 วัน';
                    if (dayCount > 0) {
                        const weekCount = Math.floor(dayCount / 5);
                        const remainingDays = dayCount % 5;
                        if (weekCount > 0 && remainingDays > 0) { displayStr = `${weekCount} สัปดาห์ / ${remainingDays} วัน`; }
                        else if (weekCount > 0) { displayStr = `${weekCount} สัปดาห์`; }
                        else { displayStr = `${remainingDays} วัน`; }
                    }
                    bodyHtml += `<td>${displayStr} (${dayCount} วัน)</td>`;
                });
                bodyHtml += '</tr>';
            });
            bodyHtml += '</tbody>';
            summaryTable.innerHTML += bodyHtml;
        }
        function renderLegend() { 
            const legendContainer = document.querySelector('.legend');
            legendContainer.innerHTML = '';
            duties.forEach((duty, index) => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `<div class="legend-color ${COLOR_PALETTE[index % COLOR_PALETTE.length]}"></div>${duty}`;
                legendContainer.appendChild(legendItem);
            });
        }
        function updateAllViews() { 
            const year = parseInt(yearSelector.value) - 543;
            generateFullYearSchedule(year);

            const yearlyPhSelector = document.getElementById('yearly-pharmacist-selector');
            const currentSelectedIndex = yearlyPhSelector ? yearlyPhSelector.value : 0;
            if (yearlyPhSelector) yearlyPhSelector.innerHTML = '';
            
            // REMOVED: monthly-pharmacist-selector logic

            pharmacistNames.forEach((name, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = name || `ภก. ${index + 1}`;
                if(yearlyPhSelector) yearlyPhSelector.appendChild(option);

                // REMOVED: monthly-pharmacist-selector logic
            });
            if(yearlyPhSelector) yearlyPhSelector.value = currentSelectedIndex;
            // REMOVED: monthly-pharmacist-selector logic
            
            renderLegend();
            renderYearlyView();
            renderMonthlyView(); // MODIFIED: This now renders the table
            renderCompareView(); 
            renderWeeklyView();
            renderSummaryView();
        }
        
        // --- SWAP LOGIC ---

        // NEW: Helper function to get the Monday of a given date
        function getMonday(d) {
            const date = new Date(d);
            const day = date.getDay(); // Sun = 0, Mon = 1, ... Sat = 6
            const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
            return new Date(date.setDate(diff));
        }

        // NEW: Helper function to clear all swap highlights
        function clearAllHighlights() {
            document.querySelectorAll('.swap-selected').forEach(el => el.classList.remove('swap-selected'));
            document.querySelectorAll('.week-selected').forEach(el => el.classList.remove('week-selected'));
        }

        // NEW: Helper function to highlight a full week in compare-view
        function highlightWeek(clickedCell, weekMonday) {
            // Find the grid this cell belongs to
            const grid = clickedCell.closest('.calendar-grid');
            if (!grid) return;

            for (let i = 0; i < 5; i++) { // Loop Mon-Fri
                const dayToHighlight = new Date(weekMonday);
                dayToHighlight.setDate(dayToHighlight.getDate() + i);
                
                const dateString = `${dayToHighlight.getFullYear()}-${String(dayToHighlight.getMonth() + 1).padStart(2, '0')}-${String(dayToHighlight.getDate()).padStart(2, '0')}`;
                
                // Find the cell *in this grid* for that date
                const cellToHighlight = grid.querySelector(`.day-cell[data-date="${dateString}"]`);
                if (cellToHighlight) {
                    cellToHighlight.classList.add('week-selected');
                }
            }
        }


        function handleSwapClick(event) {
            const cell = event.currentTarget; // This is a <td> or a <div>
            const { date, duty } = cell.dataset;
            const pharmacist = cell.dataset.pharmacist || cell.textContent;

            if (!pharmacist || !duty) return; // Not a valid swappable cell

            // Get the current swap mode
            const swapMode = document.querySelector('input[name="swap-mode"]:checked')?.value || 'week';

            if (swapMode === 'day') {
                // --- DAILY SWAP LOGIC (Original) ---
                if (!firstSwapSelection || firstSwapSelection.isWeekly) {
                    // Start new daily selection
                    clearAllHighlights(); // MODIFIED
                    cell.classList.add('swap-selected');
                    firstSwapSelection = { cell, date, duty, pharmacist, isWeekly: false };
                } else {
                    // This is the second click in daily mode
                    if (firstSwapSelection.cell === cell) {
                        clearAllHighlights(); // MODIFIED
                        firstSwapSelection = null;
                    } else if (firstSwapSelection.date === date) {
                        // Valid daily swap (same date)
                        const secondSelection = { cell, date, duty, pharmacist };
                        if (!manualOverrides[date]) manualOverrides[date] = {};
                        
                        // Apply overrides based on *current* state (which includes previous overrides)
                        const currentDutyMap = getDutiesForDate(new Date(date));
                        const duty1 = firstSwapSelection.duty;
                        const duty2 = secondSelection.duty;

                        manualOverrides[date] = { ...currentDutyMap }; // Copy current state
                        manualOverrides[date][duty1] = secondSelection.pharmacist;
                        manualOverrides[date][duty2] = firstSwapSelection.pharmacist;
                        
                        firstSwapSelection.cell.classList.add('swapped-animation');
                        secondSelection.cell.classList.add('swapped-animation');
                        
                        setTimeout(() => {
                            firstSwapSelection = null;
                            updateAllViews(); 
                            generateShareLink(true);
                        }, 500);
                    } else {
                        // New selection (different date)
                        clearAllHighlights(); // MODIFIED
                        cell.classList.add('swap-selected');
                        firstSwapSelection = { cell, date, duty, pharmacist, isWeekly: false };
                    }
                }
            } else {
                // --- WEEKLY SWAP LOGIC (NEW) ---
                const clickedDate = new Date(date);
                clickedDate.setHours(12, 0, 0, 0); // Normalize date to avoid timezone issues
                const weekMonday = getMonday(clickedDate);
                const weekMondayString = weekMonday.toISOString().split('T')[0];
                
                if (!firstSwapSelection || !firstSwapSelection.isWeekly) {
                    // Start new weekly selection
                    clearAllHighlights(); // MODIFIED
                    highlightWeek(cell, weekMonday); // NEW
                    firstSwapSelection = { cell, weekMondayString, pharmacist, isWeekly: true };
                } else {
                    // This is the second click in weekly mode
                    if (firstSwapSelection.pharmacist === pharmacist) { // Clicked same pharmacist (deselect)
                        clearAllHighlights(); // MODIFIED
                        firstSwapSelection = null;
                    } else if (firstSwapSelection.weekMondayString === weekMondayString) {
                        // Valid weekly swap (same week, different pharmacist)
                        const secondSelection = { cell, pharmacist };
                        const ph1 = firstSwapSelection.pharmacist;
                        const ph2 = secondSelection.pharmacist;
                        
                        let swapOccurred = false;
                        
                        // Loop 5 times (Mon-Fri)
                        for (let i = 0; i < 5; i++) {
                            const dayToSwap = new Date(weekMonday);
                            dayToSwap.setDate(dayToSwap.getDate() + i);
                            
                            // Use the same date format as getDutiesForDate
                            const dateStringForLookup = `${dayToSwap.getFullYear()}-${String(dayToSwap.getMonth() + 1).padStart(2, '0')}-${String(dayToSwap.getDate()).padStart(2, '0')}`;
                            
                            // Get the *current* duties for that day (including previous overrides)
                            const currentDutyMap = getDutiesForDate(dayToSwap);
                            
                            if (currentDutyMap) { // Only swap if it's a weekday
                                let duty1 = null;
                                let duty2 = null;
                                
                                // Find duties for ph1 and ph2
                                for (const duty in currentDutyMap) {
                                    if (currentDutyMap[duty] === ph1) duty1 = duty;
                                    if (currentDutyMap[duty] === ph2) duty2 = duty;
                                }

                                if (duty1 || duty2) { // Only apply override if at least one person has a duty
                                    // Start override from current state
                                    if (!manualOverrides[dateStringForLookup]) {
                                        manualOverrides[dateStringForLookup] = { ...currentDutyMap };
                                    }
                                    
                                    if (duty1) manualOverrides[dateStringForLookup][duty1] = ph2;
                                    if (duty2) manualOverrides[dateStringForLookup][duty2] = ph1;
                                    swapOccurred = true;
                                }
                            }
                        }

                        if (swapOccurred) {
                            // --- FIX: Animate the two cells that were *clicked*, not a complex query ---
                            firstSwapSelection.cell.classList.add('swapped-animation');
                            secondSelection.cell.classList.add('swapped-animation'); 
                            
                            clearAllHighlights(); // MODIFIED

                            setTimeout(() => {
                                firstSwapSelection = null;
                                updateAllViews(); 
                                generateShareLink(true);
                            }, 500);
                        } else {
                            clearAllHighlights(); // MODIFIED
                            firstSwapSelection = null;
                        }

                    } else {
                        // New selection (different week)
                        clearAllHighlights(); // MODIFIED
                        highlightWeek(cell, weekMonday); // NEW
                        firstSwapSelection = { cell, weekMondayString, pharmacist, isWeekly: true };
                    }
                }
            }
        }
        
        function handleResetSwaps() {
            // MODIFIED: Read from compare-month-selector as the button has moved
            const selectedMonth = parseInt(document.getElementById('compare-month-selector').value); 
            const year = parseInt(yearSelector.value) - 543;
            const message = `คุณต้องการล้างการสลับเวรทั้งหมดในเดือน${THAI_MONTHS[selectedMonth]}ใช่หรือไม่?`;
            
            customConfirm(message, 'ยืนยันการล้างข้อมูล', () => {
                for(const dateStr in manualOverrides) {
                    const date = new Date(dateStr);
                    if(date.getFullYear() === year && date.getMonth() === selectedMonth) {
                        delete manualOverrides[dateStr];
                    }
                }
                updateAllViews();
                generateShareLink(true);
            });
        }

        // --- MODAL & SETTINGS LOGIC ---
        function renderSettingsInputs(count) {
            const defaultDuties = ['Screener', 'IPD', 'Checker', 'Other', 'Dispense 1', 'Dispense 2'];
            dutyInputsGrid.innerHTML = '';
            nameInputsGrid.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const dutyDiv = document.createElement('div');
                dutyDiv.className = 'input-group';
                const dutyName = duties[i] || defaultDuties[i] || `หน้าที่ ${i + 1}`;
                dutyDiv.innerHTML = `<label>หน้าที่ ${i + 1}:</label><input type="text" class="duty-name" data-id="duty${i + 1}" value="${dutyName}">`;
                dutyInputsGrid.appendChild(dutyDiv);
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'input-group';
                const phName = pharmacistNames[i] || `ภก. ${String.fromCharCode(65 + i)}`;
                nameDiv.innerHTML = `<label>เภสัชกร ${i + 1}:</label><input type="text" class="pharmacist-name" data-id="ph${i + 1}" value="${phName}">`;
                nameInputsGrid.appendChild(nameDiv);
            }
        }
        function handlePersonnelUpdate() {
            const newCount = parseInt(personnelCountInput.value);
            if (newCount > 0) {
                renderSettingsInputs(newCount);
            }
        }
        function generateShareLink(silent = false) {
            let baseUrl = window.location.href.split('?')[0];
            const params = new URLSearchParams();
            params.append('year', yearSelector.value);
            
            const countInSettings = parseInt(personnelCountInput.value);
            const dutiesInSettings = Array.from(document.querySelectorAll('#duty-inputs-grid .duty-name')).map(input => input.value.trim());
            const namesInSettings = Array.from(document.querySelectorAll('#name-inputs-grid .pharmacist-name')).map(input => input.value.trim());

            params.append('count', silent ? pharmacistCount : countInSettings);
            
            const dutiesToSave = silent ? duties : dutiesInSettings;
            const namesToSave = silent ? pharmacistNames : namesInSettings;

            dutiesToSave.forEach((duty, i) => params.append(`duty${i+1}`, duty));
            namesToSave.forEach((name, i) => params.append(`ph${i+1}`, name));

            if (Object.keys(manualOverrides).length > 0) {
                const jsonString = JSON.stringify(manualOverrides);
                params.append('overrides', encodeURIComponent(jsonString));
            }

            const shareableLink = `${baseUrl}?${params.toString()}`;
            
            if (silent) {
                 // MODIFIED: history.pushState() is blocked in this 'blob:' environment (SecurityError).
                 // We will simply not update the URL silently.
                 // The main "Save" button will still work as it forces a reload.
                 // history.pushState(null, '', shareableLink); 
                 return; // Do nothing, prevent the error
            } else {
                // Use clipboard API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(shareableLink).then(() => {
                        customAlert('คัดลอกลิงก์สำเร็จแล้ว!\nคุณสามารถส่งลิงก์นี้ให้ทีมเพื่อดูตารางเวรได้เลย', 'คัดลอกลิงก์');
                        settingsModal.style.display = 'none';
                        if (window.location.href !== shareableLink) {
                            window.location.href = shareableLink;
                        }
                    }, () => {
                         // Fallback for restricted environments
                         customAlert('ไม่สามารถคัดลอกลิงก์อัตโนมัติได้ กรุณาคัดลอกลิงก์ด้านล่างนี้:\n' + shareableLink, 'คัดลอกลิงก์');
                    });
                } else {
                     // Fallback for older browsers (less common now)
                     customAlert('ไม่สามารถคัดลอกลิงก์อัตโนมัติได้ กรุณาคัดลอกลิงก์ด้านล่างนี้:\n' + shareableLink, 'คัดลอกลิงก์');
                }
            }
        }
        
        // --- INITIALIZATION ---
        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            if (!params.has('count')) {
                pharmacistCount = 6;
                duties = ['Screener', 'IPD', 'Checker', 'Other', 'Dispense 1', 'Dispense 2'];
                pharmacistNames = ['ภก. A', 'ภก. B', 'ภก. C', 'ภก. D', 'ภก. E', 'ภก. F'];
            } else {
                const yearFromUrl = params.get('year');
                if (yearFromUrl) if (Array.from(yearSelector.options).some(opt => opt.value === yearFromUrl)) yearSelector.value = yearFromUrl;
                
                pharmacistCount = parseInt(params.get('count'));
                duties = [];
                for (let i = 0; i < pharmacistCount; i++) duties.push(params.get(`duty${i+1}`) || `หน้าที่ ${i+1}`);
                pharmacistNames = [];
                for (let i = 0; i < pharmacistCount; i++) pharmacistNames.push(params.get(`ph${i+1}`) || `ภก. ${String.fromCharCode(65 + i)}`);
            
                if (params.has('overrides')) {
                    try {
                        manualOverrides = JSON.parse(decodeURIComponent(params.get('overrides')));
                    } catch (e) {
                        console.error("Could not parse overrides from URL", e);
                        manualOverrides = {};
                    }
                }
            }
        }

        function populateYearSelector() { 
            const currentCEYear = new Date().getFullYear();
            for (let i = currentCEYear - 10; i <= currentCEYear + 10; i++) {
                const option = document.createElement('option');
                const yearBE = i + 543;
                option.value = yearBE;
                option.textContent = yearBE;
                yearSelector.appendChild(option);
            }
             yearSelector.value = currentCEYear + 543;
        }
        
        function populateSelectors(year) {
            const monthlySelector = document.getElementById('monthly-selector');
            const weeklySelector = document.getElementById('weekly-selector');
            // MODIFIED: Get swap selectors
            const compareMonthSelector = document.getElementById('compare-month-selector'); // MODIFIED
            
            // REMOVED: monthly-pharmacist-selector logic

            monthlySelector.innerHTML = '';
            weeklySelector.innerHTML = '';
            compareMonthSelector.innerHTML = ''; // MODIFIED
            // (monthlyPhSelector is populated in updateAllViews)

            THAI_MONTHS.forEach((m, i) => {
                monthlySelector.innerHTML += `<option value="${i}">${m}</option>`;
                compareMonthSelector.innerHTML += `<option value="${i}">${m}</option>`; // MODIFIED
            });

            let mondaysInYear = [];
            let d = new Date(year, 0, 1);
            if (d.getDay() !== 1) { d.setDate(d.getDate() + (8 - d.getDay()) % 7); }
            if (d.getFullYear() < year) { d.setDate(d.getDate() + 7); }
            
            while(d.getFullYear() === year) {
                mondaysInYear.push(new Date(d));
                d.setDate(d.getDate() + 7);
            }
            
            mondaysInYear.forEach((monday, i) => {
                weeklySelector.innerHTML += `<option value="${i}">สัปดาห์ที่ ${i+1} (เริ่ม ${monday.getDate()}/${monday.getMonth()+1})</option>`;
            });

            const today = new Date();
            if (today.getFullYear() === year) {
                const currentMonth = today.getMonth();
                
                monthlySelector.value = currentMonth;
                compareMonthSelector.value = currentMonth; // MODIFIED

                let weekVal = -1;
                 for(let i=0; i < mondaysInYear.length; i++) {
                     const monday = mondaysInYear[i];
                     const nextMonday = new Date(monday);
                     nextMonday.setDate(nextMonday.getDate() + 7);
                     if (today >= monday && today < nextMonday) {
                         weekVal = i;
                         break;
                     }
                 }
                if (weekVal !== -1 && weeklySelector.options[weekVal]) {
                    weeklySelector.value = weekVal;
                }
            } else {
                monthlySelector.value = 0;
                compareMonthSelector.value = 0; // MODIFIED
                weeklySelector.value = 0;
            }
        }
        
        function handleYearChange() {
            const yearBE = parseInt(yearSelector.value);
            populateSelectors(yearBE - 543);
            updateAllViews();
            
            // Generate a new URL silent
            generateShareLink(true);
        }

        function initialize() {
            populateYearSelector();
            loadFromURL();
            
            const year = parseInt(yearSelector.value) - 543;
            populateSelectors(year);
            updateAllViews();
            switchView('yearly-view');
            
            navButtons.forEach(btn => btn.addEventListener('click', () => switchView(btn.id.replace('nav-', '') + '-view')));
            yearSelector.addEventListener('change', handleYearChange);
            document.getElementById('yearly-pharmacist-selector').addEventListener('change', renderYearlyView);
            document.getElementById('monthly-selector').addEventListener('change', renderMonthlyView);
            // REMOVED: monthly-pharmacist-selector listener
            document.getElementById('weekly-selector').addEventListener('change', renderWeeklyView);
            // MODIFIED: Add listeners for new swap selectors
            document.getElementById('compare-month-selector').addEventListener('change', renderCompareView); // MODIFIED
            resetSwapsButton.addEventListener('click', handleResetSwaps);
            
            settingsButton.addEventListener('click', () => {
                personnelCountInput.value = pharmacistCount || 6;
                renderSettingsInputs(personnelCountInput.value);
                settingsModal.style.display = 'block';
            });
            closeModalButton.addEventListener('click', () => settingsModal.style.display = 'none');
            window.addEventListener('click', (event) => { if (event.target == settingsModal) settingsModal.style.display = 'none'; });
            personnelUpdateButton.addEventListener('click', handlePersonnelUpdate);
            generateLinkButton.addEventListener('click', () => generateShareLink(false));

            // Custom Modal Listeners
            const customModal = document.getElementById('custom-modal');
            const customModalTitle = document.getElementById('custom-modal-title');
            const customModalMessage = document.getElementById('custom-modal-message');
            const customModalConfirm = document.getElementById('custom-modal-confirm');
            const customModalCancel = document.getElementById('custom-modal-cancel');

            customModalCancel.addEventListener('click', () => {
                customModal.style.display = 'none';
                customModalConfirmCallback = null;
            });
            customModalConfirm.addEventListener('click', () => {
                customModal.style.display = 'none';
                if (customModalConfirmCallback) {
                    customModalConfirmCallback();
                }
                customModalConfirmCallback = null;
            });
        }

        // --- CUSTOM MODAL HELPERS ---
        function customAlert(message, title = 'แจ้งเตือน') {
            document.getElementById('custom-modal-title').textContent = title;
            // Allow newlines in alerts
            document.getElementById('custom-modal-message').innerHTML = message.replace(/\n/g, '<br>');
            document.getElementById('custom-modal-confirm').textContent = 'ตกลง';
            document.getElementById('custom-modal-cancel').style.display = 'none';
            document.getElementById('custom-modal').style.display = 'block';
            customModalConfirmCallback = null;
        }

        function customConfirm(message, title = 'ยืนยัน', callback) {
            document.getElementById('custom-modal-title').textContent = title;
            document.getElementById('custom-modal-message').innerHTML = message.replace(/\n/g, '<br>');
            document.getElementById('custom-modal-confirm').textContent = 'ยืนยัน';
            document.getElementById('custom-modal-cancel').textContent = 'ยกเลิก';
            document.getElementById('custom-modal-cancel').style.display = 'inline-block';
            document.getElementById('custom-modal').style.display = 'block';
            customModalConfirmCallback = callback;
        }

        window.addEventListener('load', initialize);
    </script>
</body>
</html>





